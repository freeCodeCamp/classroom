import Head from 'next/head';
import styles from '../../styles/Home.module.css';
import Navbar from '../../components/navbar';
import Link from 'next/link';
import { getSession } from 'next-auth/react';
import prisma from '../../prisma/prisma';
import AdminTable from '../../components/adminTable';

export async function getServerSideProps(ctx) {
  const userSession = await getSession(ctx);
  if (!userSession) {
    ctx.res.writeHead(302, { Location: '/' });
    ctx.res.end();
    return {};
  }

  const user = await prisma.User.findUnique({
    where: {
      email: userSession['user']['email']
    },
    select: {
      email: true,
      role: true
    }
  });

  if (user.role != 'ADMIN') {
    ctx.res.writeHead(302, { Location: '/error' });
    ctx.res.end();
    return {};
  }

  const users = await prisma.User.findMany({
    select: {
      id: true,
      name: true,
      email: true,
      role: true
    }
  });
  return {
    props: {
      userSession,
      users: users
    }
  };
}

export default function Home(props) {
  const columns = [
    {
      name: 'Name',
      selector: row => row.name
    },
    {
      name: 'Email',
      selector: row => row.userEmail
    },
    {
      name: 'Role',
      selector: row => row.role
    },
    {
      name: 'Actions',
      selector: row => row.adminActions
    }
  ];
  return (
    <>
      <div className={styles.container}>
        <Head>
          <title>Create Next App</title>
          <meta name='description' content='Generated by create next app' />
          <link rel='icon' href='/favicon.ico' />
        </Head>
        <Navbar>
          <div className='border-solid border-2 pl-4 pr-4'>
            <Link href={'/classes'}>Classes</Link>
          </div>
          <div className='border-solid border-2 pl-4 pr-4'>
            <Link href={'/'}> Menu</Link>
          </div>
        </Navbar>
        <div className={styles.boxx}>
          <h1 className='text-[40px] text-center big-heading underline'>
            Admin
          </h1>
        </div>
        <AdminTable columns={columns} data={props.users}></AdminTable>
      </div>
    </>
  );
}
